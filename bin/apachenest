#!/usr/bin/env bash
set -e

INSTALL_DIR="$HOME/Documents/.apachenest"
WWW_DIR="$INSTALL_DIR/www"
CONF_DIR="$INSTALL_DIR/conf"

# Colors and emojis
GREEN="\033[0;32m"
BLUE="\033[0;34m"
YELLOW="\033[1;33m"
NC="\033[0m"
CHECK="✔️"
ERROR="❌"
ROCKET="🚀"
GEAR="⚙️"
DOWNLOAD="📥"
HOURGLASS="⏳"
SUCCESS="🎉"

# Loading spinner function
spinner() {
	local pid=$!
	local delay=0.15
	local spinstr='|/-\'
	while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
		local temp=${spinstr#?}
		printf " [%c]  " "$spinstr"
		local spinstr=$temp${spinstr%"$temp"}
		sleep $delay
		printf "\b\b\b\b\b\b"
	done
	printf "    \b\b\b\b"
}

setup_nix_portable() {
	echo -e "\n${BLUE}${ROCKET} Installing Nix-Portable ${ROCKET}${NC}"
	echo -e "${YELLOW}📁 Target directory: ${GREEN}$INSTALL_DIR${NC}\n"

	# Create directory structure
	echo -e "${GEAR} ${YELLOW}Creating directory structure...${NC}"
	mkdir -p "$INSTALL_DIR/bin"
	echo -e "${CHECK} ${GREEN}Directories created!${NC}"

	# Download nix-portable
	echo -e "\n${DOWNLOAD} ${YELLOW}Downloading nix-portable...${NC}"
	curl -L https://github.com/DavHau/nix-portable/releases/latest/download/nix-portable-$(uname -m) > $INSTALL_DIR/bin/nix-portable
	chmod +x "$INSTALL_DIR/bin/nix-portable"
	echo -e "${CHECK} ${GREEN}Download complete!${NC}"

	# Verify installation
	echo -e "\n${HOURGLASS} ${YELLOW}Verifying installation...${NC}"
	nix-portable nix-shell --version
	echo -e "${CHECK} ${GREEN}Verification complete!${NC}"
	echo -e "\n${SUCCESS} ${GREEN}Installation complete!${NC}"
}

echo -e "\n${GEAR} ${YELLOW}Configuring environment...${NC}"
export NP_LOCATION="$INSTALL_DIR"
export PATH="$PATH:$INSTALL_DIR/bin"
export NP_GIT="$(which git)"
echo -e "${CHECK} ${GREEN}Environment configured!${NC}"

[[ ! -f "$INSTALL_DIR/bin/nix-portable" ]] && setup_nix_portable

nix-portable nix-shell -p apacheHttpd php82 --run "
echo -e '\n${CHECK} Apache version:'
httpd -v
echo -e '\n${CHECK} PHP version:'
php --version
"

echo -e "\n${GEAR} ${YELLOW}Setting up ApacheNest directories...${NC}"
mkdir -p "$WWW_DIR"
mkdir -p "$CONF_DIR"
mkdir -p "$INSTALL_DIR/apache"
mkdir -p "$INSTALL_DIR/apache/logs"

APACHE_PATH=$(nix-portable nix-shell -p apacheHttpd --run "echo \$(dirname \$(dirname \$(which httpd)))")
echo -e "${CHECK} ${GREEN}Apache found at: ${BLUE}$APACHE_PATH${NC}"


cat > "$WWW_DIR/index.php" <<EOF
<?php phpinfo(); ?>
EOF

cat > "$CONF_DIR/php-fpm.conf" <<EOF
[global]
error_log = $INSTALL_DIR/php-fpm.log

[www]
listen = 127.0.0.1:9000
listen.allowed_clients = 127.0.0.1
user = nobody
group = nogroup
pm = dynamic
pm.max_children = 5
pm.start_servers = 2
pm.min_spare_servers = 1
pm.max_spare_servers = 3
chdir = /
EOF

cat > "$CONF_DIR/httpd.conf" <<EOF
ServerName 127.0.0.1
ServerRoot "$INSTALL_DIR/apache"
Listen 8080
LoadModule mpm_event_module $APACHE_PATH/modules/mod_mpm_event.so
LoadModule proxy_module $APACHE_PATH/modules/mod_proxy.so
LoadModule proxy_fcgi_module $APACHE_PATH/modules/mod_proxy_fcgi.so
LoadModule dir_module $APACHE_PATH/modules/mod_dir.so
LoadModule mime_module $APACHE_PATH/modules/mod_mime.so
LoadModule authz_core_module $APACHE_PATH/modules/mod_authz_core.so
LoadModule unixd_module $APACHE_PATH/modules/mod_unixd.so

DocumentRoot "$WWW_DIR"
<Directory "$WWW_DIR">
    Require all granted
</Directory>

DirectoryIndex index.php index.html

<FilesMatch \.php$>
    SetHandler "proxy:fcgi://127.0.0.1:9000"
</FilesMatch>

TypesConfig $APACHE_PATH/conf/mime.types
EOF

echo -e "${CHECK} ${GREEN}ApacheNest config ready!${NC}"

# Run both PHP-FPM and Apache inside nix-portable shell
echo -e "\n${ROCKET} ${YELLOW}Launching ApacheNest...${NC}"

nix-portable nix-shell -p apacheHttpd php82 --run "
trap 'pkill -P $$' EXIT  # Cleanup child processes on exit
php-fpm -y $CONF_DIR/php-fpm.conf &
httpd -f $CONF_DIR/httpd.conf &
wait  # Keep shell alive
"
